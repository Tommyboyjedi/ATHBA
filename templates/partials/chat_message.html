<!-- templates/partials/chat_message.html -->
<div class="message {% if msg.sender == 'user' %}message-human{% else %}message-system{% endif %}">

  {# If a message requests opening the Spec panel, trigger a one-time HTMX load #}
  {% if msg.metadata.open_spec_panel %}
    <div class="open-spec" hx-sync="this:queue">
      <div hx-get="/api/ui/spec/"
           hx-trigger="load"
           hx-target="#main-panel"
           hx-swap="innerHTML"></div>
    </div>
  {% endif %}

  {# If either switch or refresh is requested, wrap them so HTMX queues requests in order #}
  {% if msg.metadata.switch_project_id or msg.metadata.refresh_overview %}
    <div class="switch-refresh" hx-sync="this:queue">
      {# 1) Switch the session project_id FIRST #}
      {% if msg.metadata.switch_project_id %}
        <form hx-post="/api/projects/switch/"
              hx-trigger="load"
              hx-swap="none">
          <input type="hidden" name="project_id" value="{{ msg.metadata.switch_project_id }}" />
        </form>
      {% endif %}

      {# 2) THEN refresh overview (returns OOB selector that uses request.session['project_id']) #}
      {% if msg.metadata.refresh_overview %}
        <div hx-get="/api/ui/overview/"
             hx-target="#main-panel"
             hx-swap="innerHTML"
             hx-trigger="load"></div>
      {% endif %}
    </div>
  {% endif %}

  <strong>{{ msg.sender }}:</strong> {{ msg.content|safe }}
</div>
