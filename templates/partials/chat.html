{% load static %}

<div class="chat-container">
  <div class="chat-header">
    <h2 class="font-semibold">Chat – {{ project.name }}</h2>
  </div>

  <div id="chat-stream" class="chat-stream" hx-ext="sse" sse-connect="/chat/stream/?session={{ request.session.session_key }}" sse-swap="chat" hx-swap="beforeend">
    {% for msg in chat_log %}
      <div class="message {% if msg.sender == 'human' %}message-human{% else %}message-system{% endif %}">
        <strong>{{ msg.sender }}:</strong> {{ msg.message }}
      </div>
    {% endfor %}
  </div>

<form id="chat-form"
      hx-post="/api/chat/send"
      hx-target="#chat-form"
      hx-swap="none"
      hx-on::after-request="this.reset()"
      class="chat-form">
  {% csrf_token %}
  <input type="hidden" name="session_key" value="{{ request.session.session_key }}">
  <input
      type="text"
      name="message"
      oninput="this.setCustomValidity('')"
      oninvalid="this.setCustomValidity('Type something!')"
      placeholder="Type a message…"
      class="chat-input"
      autocomplete="off"
      required
    />

  <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Send</button>
</form>


</div>
<script>
  document.addEventListener('DOMContentLoaded', (event) => {
    console.log('DOM fully loaded. Initializing HTMX chat processing.');
    const chatStream = document.getElementById('chat-stream');
    if (chatStream) {
      console.log('Found chat-stream element. Processing...');
      htmx.process(chatStream);
      chatStream.addEventListener('htmx:sseError', function(evt) {
        console.error('HTMX SSE Error:', evt.detail.error);
      });
      console.log('SSE event listener for errors attached.');
    } else {
      console.error('Could not find #chat-stream element.');
    }
  });
</script>