{% load static %}

<div class="chat-container">
  <div class="chat-header">
    <h2 class="font-semibold">Chat – {{ project.name }}</h2>
  </div>

  <div id="chat-stream" class="chat-stream" hx-ext="sse" sse-connect="/chat/stream/?session={{ request.session.session_key }}" sse-swap="chat" hx-swap="beforeend">
    {% for msg in chat_log %}
      <div class="message {% if msg.sender == 'human' %}message-human{% else %}message-system{% endif %}">
        <strong>{{ msg.sender }}:</strong> {{ msg.message }}
      </div>
    {% endfor %}
  </div>

<form id="chat-form"
      hx-post="/api/chat/send"
      hx-target="#chat-form"
      hx-swap="none"
      hx-on::after-request="this.reset()"
      class="chat-form">
  {% csrf_token %}
  <input type="hidden" name="session_key" value="{{ request.session.session_key }}">
  <input
      type="text"
      name="message"
      oninput="this.setCustomValidity('')"
      oninvalid="this.setCustomValidity('Type something!')"
      placeholder="Type a message…"
      class="chat-input"
      autocomplete="off"
      required
    />

  <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Send</button>
</form>


</div>
<script>
  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  document.addEventListener('DOMContentLoaded', (event) => {
    const chatStream = document.getElementById('chat-stream');
    const chatForm = document.getElementById('chat-form');
    const messageInput = chatForm.querySelector('input[name="message"]');

    if (chatStream) {
      // Initialize HTMX SSE
      htmx.process(chatStream);
      chatStream.addEventListener('htmx:sseError', function(evt) {
        console.error('HTMX SSE Error:', evt.detail.error);
      });
    } else {
      console.error('Could not find #chat-stream element.');
    }

    if (chatForm) {
      chatForm.addEventListener('htmx:beforeRequest', function(evt) {
        const messageContent = evt.detail.requestConfig.parameters.message;
        if (!messageContent || messageContent.trim() === '') return;

        // Create and append the user's message optimistically
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message message-human';
        messageDiv.innerHTML = `<strong>user:</strong> ${escapeHtml(messageContent)}`;
        chatStream.appendChild(messageDiv);

        // Scroll to the bottom
        chatStream.scrollTop = chatStream.scrollHeight;

        // Reset the form immediately
        chatForm.reset();
        // Re-focus the input
        messageInput.focus();
      });
    }
  });
</script>